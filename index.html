<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث عن الكنز - مغامرة الألغاز</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- إعداد خطوط كرتونية جديدة (Lalezar للعناوين و Changa للنص العام) -->
    <style>
        /* تحميل الخطوط الجديدة */
        @import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;700;800&family=Lalezar&family=Cairo:wght@700;900&display=swap');
        
        body {
            /* استخدام Changa كخط أساسي قوي */
            font-family: 'Changa', sans-serif; 
            /* خلفية الكوميك بوك: لون أصفر فاتح ساطع */
            background-color: #FFECB3; /* Light Comic Yellow/Cream */
            position: relative;
            overflow: auto;
            
            /* تأثير النقوش النقطية (Halftone Dots) */
            background-image: radial-gradient(#00000020 1px, transparent 1px);
            background-size: 8px 8px; 
        }
        
        /* إزالة الحركة المعقدة في الخلفية */
        .moving-elements::before { content: none; }
        
        /* تأثير اهتزاز خفيف للعنوان الرئيسي */
        @keyframes popOut {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* تصميم العنوان الرئيسي بأسلوب الكوميك (ظل نصي ضخم) */
        .splash-title {
            /* استخدام Lalezar لخط عنوان رئيسي كرتوني ومختلف */
            font-family: 'Lalezar', cursive; 
            text-shadow: 6px 6px 0px #000, 
                         12px 12px 0px #F6E05E; /* حدود سوداء قوية وظل أصفر أكبر */
            animation: popOut 3s ease-in-out infinite alternate;
        }
        
        /* تطبيق Lalezar على الأزرار لجعلها أكثر كرتونية وجاذبية */
        .btn-comic-primary, .btn-comic-secondary {
            font-family: 'Lalezar', cursive;
        }
        /* تصميم البطاقة كإطار كوميك (Panel/Banner) */
        .game-card {
            border: 6px solid #000; /* حدود سوداء أكثر سمكاً */
            /* ظل مزدوج لـ "بانر" متحرك */
            box-shadow: 12px 12px 0px #E53E3E, -6px -6px 0px #3182CE; 
            transition: all 0.1s ease-in-out;
            background-color: #ffffff; 
            /* ميلان خفيف للأمام */
            transform: rotate(1deg);
        }
        /* لتقليل دوران البطاقة على شاشات الجوال */
        @media (max-width: 768px) {
            .game-card {
                transform: rotate(0deg);
                box-shadow: 8px 8px 0px #E53E3E, -4px -4px 0px #3182CE; 
            }
            .game-card:hover {
                transform: rotate(0deg) scale(1.0); 
            }
        }
        .game-card:hover {
            transform: rotate(1deg) scale(1.0); 
        }

        /* تصميم الأزرار بأسلوب الكوميك (POW!) */
        .btn-comic-primary {
            border: 4px solid #000;
            box-shadow: 0 10px 0 0 #3182CE; /* ظل أزرق للعمق */
            transition: all 0.1s;
            transform: skewX(-8deg); /* إمالة النص للحركة أقوى */
            letter-spacing: 2px;
            font-weight: 900;
        }
        .btn-comic-primary:active {
            transform: translateY(6px) skewX(-8deg);
            box-shadow: 0 4px 0 0 #3182CE;
        }

        /* تصميم الأزرار بأسلوب الكوميك (POW!) */
        .btn-comic-secondary {
            border: 4px solid #000;
            box-shadow: 0 10px 0 0 #E53E3E; /* ظل أحمر للعمق */
            transition: all 0.1s;
            transform: skewX(-8deg);
            letter-spacing: 2px;
            font-weight: 900;
        }
        .btn-comic-secondary:active {
            transform: translateY(6px) skewX(-8deg);
            box-shadow: 0 4px 0 0 #E53E3E;
        }

        /* صندوق اللغز بتصميم مميز */
        .clue-box {
            border: 4px solid #000; 
            background-color: #F6E05E; /* أصفر فاتح/لهجة */
            box-shadow: 6px 6px 0px #3182CE; /* ظل أزرق */
        }
        /* تحديد موقع اللوجو لجعله جزءاً من خلفية الصفحة */
        .background-logo {
            transform: rotate(-5deg); /* إمالة خفيفة لمظهر أكثر حيوية */
            z-index: 0; /* يبقى خلف العناصر الرئيسية للعبة */
            /* لا يوجد ظل لضمان ظهور اللوجو المفرغ بشكل صحيح */
        }
        /* تأكد أن بطاقة اللعبة الرئيسية تظهر فوق اللوجو */
        #app {
            z-index: 10;
        }
        
        /* تصميم صندوق الشبهات (الإنجاز) */
        .doubt-box {
            background-color: #FEE2E2; /* أحمر فاتح جداً (كخلفية تنبيه) */
            border-color: #DC2626; /* أحمر قوي للحدود */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#E53E3E', // Comic Red - الأساسي
                        'secondary': '#3182CE', // Comic Blue - الثانوي
                        'accent': '#F6E05E', // Comic Yellow - لهجة
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 moving-elements">

    <!-- اللوجو الجديد - عنصر مطلق الموقع (Fixed) بدون ظل ومكرر -->
    
    <!-- النسخة 1: أعلى اليسار - الأكبر والأكثر وضوحاً -->
    <img id="logo-1" src="game logo.png" 
         alt="شعار اللعبة في الخلفية 1" 
         class="fixed top-4 left-4 background-logo w-24 h-24 md:w-32 md:h-32 lg:w-96 lg:h-96 object-contain opacity-50 transform rotate-[-5deg]"
         onerror="this.onerror=null; this.src='https://placehold.co/256x256/FFECB3/3182CE?text=LOGO';" />

    <!-- النسخة 2: أسفل اليمين - متوسط الحجم -->
    <img id="logo-2" src="game logo.png" 
         alt="شعار اللعبة في الخلفية 2" 
         class="fixed bottom-4 right-4 background-logo w-16 h-16 md:w-24 md:h-24 lg:w-48 lg:h-48 object-contain opacity-40 transform rotate-[10deg]"
         onerror="this.onerror=null; this.src='https://placehold.co/256x256/FFECB3/3182CE?text=LOGO';" />

    <!-- النسخة 3: أعلى اليمين - صغير وسري (يختفي على الجوال الصغير) -->
    <img id="logo-3" src="game logo.png" 
         alt="شعار اللعبة في الخلفية 3" 
         class="fixed top-1/4 right-1/4 background-logo w-8 h-8 md:w-16 md:h-16 lg:w-24 lg:h-24 object-contain opacity-20 transform rotate-[25deg] hidden sm:block"
         onerror="this.onerror=null; this.src='https://placehold.co/256x256/FFECB3/3182CE?text=LOGO';" />

    <!-- النسخة 4: أسفل اليسار - متوسط الحجم (يختفي على الجوال الصغير) -->
    <img id="logo-4" src="game logo.png" 
         alt="شعار اللعبة في الخلفية 4" 
         class="fixed bottom-1/3 left-1/4 background-logo w-12 h-12 md:w-20 md:h-20 lg:w-32 lg:h-32 object-contain opacity-30 transform rotate-[-15deg] hidden sm:block"
         onerror="this.onerror=null; this.src='https://placehold.co/256x256/FFECB3/3182CE?text=LOGO';" />


    <!-- الحاوية الرئيسية للتطبيق -->
    <div id="app" class="w-full max-w-lg rounded-xl game-card overflow-hidden">
        <!-- يتم تحميل محتوى اللعبة هنا بواسطة JavaScript -->
    </div>

    <!-- زر مفتاح الشفرة - تم وضعه خارج البطاقة ويتحكم به JavaScript -->
    <button id="cipher-button-toggle" onclick="toggleCipherKey()" class="fixed top-4 right-4 bg-primary btn-comic-primary text-white p-3 rounded-xl shadow-lg hover:bg-primary/90 transition duration-200 z-40 text-sm md:text-base font-bold transform skewX(0deg) hidden">
        مفتاح الشفرة
    </button>

    <!-- مفتاح الشفرة - الشريط الجانبي (المودال) -->
    <div id="cipher-key-modal" class="fixed top-0 right-0 h-full w-full md:w-96 bg-gray-900 bg-opacity-95 text-white transform translate-x-full transition-transform duration-300 z-50 p-6 flex flex-col shadow-2xl" style="direction: rtl;">
        <!-- زر الإغلاق -->
        <button onclick="toggleCipherKey()" class="text-white text-3xl font-black absolute top-4 left-4 hover:text-primary z-50">
            &times;
        </button>
        <h3 class="text-2xl font-black mb-4 border-b pb-2 border-primary text-accent">مفتاح الشفرة</h3>
        <p class="text-sm mb-4 text-gray-300">الصورة تستخدم للمساعدة في فك رموز الألغاز (إذا تطلب الأمر).</p>

        <!-- صورة مفتاح الشفرة -->
        <div class="flex justify-center items-center h-full flex-grow">
            <img 
                src="https://www.barascout.com/images/Capture_1.png" 
                alt="صورة مفتاح الشفرة المربعية (Polybius Square)" 
                class="max-w-full max-h-full object-contain rounded-lg border-4 border-accent shadow-xl"
                onerror="this.onerror=null; this.src='https://placehold.co/400x400/3182CE/FFFFFF?text=تعذر+تحميل+الصورة'"
            />
        </div>
    </div>


    <!-- نافذة الرسائل المنبثقة (بديل لـ alert) -->
    <div id="message-box" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center game-card">
            <h3 id="message-title" class="text-2xl font-black mb-3 text-red-600">خطأ</h3>
            <p id="message-content" class="text-gray-700 mb-6"></p>
            <button onclick="hideMessageBox()" class="w-full bg-primary btn-comic-primary text-white py-2 rounded-lg hover:bg-primary/90 text-lg transition duration-150">حسناً</button>
        </div>
    </div>

<script>
    // بيانات اللعبة الأساسية، يتم تقسيمها حسب الفريق ID
    // يتم استخدام ID الفريق (1, 2, 3...) كمفتاح للوصول إلى مراحلهم
    const TEAM_STAGES = {
        // =======================================================
        // بيانات الفريق الأول (المفتاح: 1) - فريق نينوى
        // =======================================================
        1: [
            {
                stage: 1,
                clue: "ابحث عن تمثال المسيح الراعي في المنطقة المفتوحة. كلمة السر مخبأة في محيطه.",
                location_name: "تمثال المسيح الراعي",
                password: "مفيبوشث", // تحديث كلمة السر
                // تحديث نص الإنجاز للشبهة
                reveal_content: "الملاك كذب وقال إنه عزريا بن حننيا وأنه من نفس عشيرة طوبيا !", 
                next_button_text: "انتقل إلى التحدي التالي"
            },
            {
                stage: 2,
                clue: "توجه إلى مكتب ابونا انطون وابحث عن دليل يحمل كلمة السر.",
                location_name: "مكتب ابونا انطون",
                password: "جدعون", // تحديث كلمة السر
                reveal_content: "الملاك رافائيل استخدم اسما بشريا كجزء من رسالته لإخفاء طبيعته وإكمال مهمته كإنسان ولما قال انه من نفس العشيرة كان يقصد انه بيخدم نفس الإله ، ومعنى اسم عزريا الله أعان ومعنى اسم حننيا الله تحنن ، فهنا الملاك ذكر مهمته ولكن طوبيا فهمها انها اسم وليس وصف",
                next_button_text: "للوجهة الأخيرة"
            },
            {
                stage: 3,
                clue: "توجه إلى أيقونة مارمرقس في المنطقة. كلمة السر مخبأة في محيط الأيقونة.", 
                // تحديث الموقع
                location_name: "قدام أيقونة مارمرقس", 
                password: "برغامس", // تحديث كلمة السر
                reveal_content: "قضاة ١٣ : ١١ - ١٨\nتكوين ٣٢ : ٢٩",
                next_button_text: "أنهي المغامرة!"
            },
        ],
        
        // =======================================================
        // بيانات الفريق الثاني (المفتاح: 2) - فريق راجيس
        // =======================================================
        2: [
            {
                stage: 1,
                clue: "توجه إلى العمود الموجود أمام الكنيسة اللي تحت. كلمة السر مخبأة في محيطه.",
                location_name: "أمام الكنيسة اللي تحت (عند العمود)",
                password: "باراق", // تحديث كلمة السر
                // تحديث نص الإنجاز للشبهة
                reveal_content: "طوبيا قال إن الصدقة تغفر الخطايا وتنجي من الهلاك !", 
                next_button_text: "انتقل إلى التحدي التالي"
            },
            {
                stage: 2,
                clue: "ابحث في مكتب ابونا أنسطاسي عن دليل يحمل كلمة السر.",
                location_name: "مكتب ابونا أنسطاسي",
                password: "أحيور", // تحديث كلمة السر
                reveal_content: "دم السيد المسيح هو الذي يغفر الخطايا ولكن الأعمال هي التي تثبت إن ايمان الإنسان حي وتثبت قبوله لعمل الفداء",
                next_button_text: "للوجهة الأخيرة"
            },
            {
                stage: 3,
                clue: "ابحث عن أيقونة الملاك غبريال في المنطقة. كلمة السر مخبأة في محيط الأيقونة.",
                // تحديث الموقع
                location_name: "قدام أيقونة الملاك غبريال", 
                password: "عوبديا", // تحديث كلمة السر
                reveal_content: "لوقا ١٢ : ٣٣\nيعقوب ٢ : ١٤ _ ٢٦",
                next_button_text: "أنهي المغامرة!"
            },
        ],

        // =======================================================
        // بيانات الفريق الثالث (المفتاح: 3) - فريق ارارط
        // =======================================================
        3: [
            {
                stage: 1,
                clue: "توجه إلى صندوق الشكاوى الموجود بجوار مكتب أبونا تواضروس. كلمة السر مخبأة في محيطه.",
                location_name: "صندوق الشكاوى (بجوار مكتب أبونا تواضروس)",
                // **تم التحقق والتأكيد من هذه الكلمة لتجنب أي مشكلة في التنسيق**
                password: "ملاخي", 
                // تحديث نص الإنجاز للشبهة
                reveal_content: "استخدم الكبد ومرارة الحوت دليل على استعمال السحر وأعمال الشيطان!", 
                next_button_text: "انتقل إلى التحدي التالي"
            },
            {
                stage: 2,
                clue: "توجه إلى المكتبة القديمة. الورقة موجودة قدامها وتحمل كلمة السر.", 
                location_name: "أمام المكتبة القديمة", 
                password: "أبفراس", // تحديث كلمة السر
                reveal_content: "الكبد مركز السموم التي مكانها خارج الجسم فهو رمز الخطية التي طبيعتها خارجة عن الجسم وكان يستخدم الكبد كتقدمة في ذبيحة الاثم",
                next_button_text: "للوجهة الأخيرة"
            },
            {
                stage: 3,
                clue: "ابحث عن كلمة السر قدام باب هيكل الرجالة.",
                // تحديث الموقع
                location_name: "قدام باب هيكل الرجالة", 
                password: "أبشالوم", // تحديث كلمة السر
                reveal_content: "الطقوس السحرية تقدم لخدمة الشيطان وحرق الكبد يعني مضادة للشيطان",
                next_button_text: "أنهي المغامرة!"
            },
        ],

        // =======================================================
        // بيانات الفريق الرابع (المفتاح: 4) - فريق أورشليم
        // =======================================================
        4: [
            {
                stage: 1,
                clue: "توجه إلى الموقع أمام مبنى الخدمات. كلمة السر مخبأة في محيطه.",
                location_name: "قدام مبنى الخدمات",
                password: "حزقيا", // تحديث كلمة السر
                // تحديث نص الإنجاز للشبهة
                reveal_content: "ازاي طوبيا يفقد نظره من مجرد طائر", 
                next_button_text: "انتقل إلى التحدي التالي"
            },
            {
                stage: 2,
                clue: "ابحث داخل الغرفة الزجاجية (الاوضة الإزاز) عن دليل يحمل كلمة السر.",
                location_name: "الاوضة الإزاز",
                password: "يثرون", // تحديث كلمة السر
                reveal_content: "جفاف العين مرض يحدث بسبب الاكتئاب والمشاكل العصبية كما كان يحدث مع طوبيت ( طوبيا ٢ : ٥_ ١٠)\nعند حدوث التهاب في العين في هذه الحالة لا توجد دموع كافية لمعالجة الالتهاب بسبب جفاف العين",
                next_button_text: "للوجهة الأخيرة"
            },
            {
                stage: 3,
                clue: "توجه إلى ممر باب هيكل السيدات. كلمة السر مخبأة في محيط الباب.",
                // تحديث الموقع
                location_name: "قدام باب هيكل السيدات", 
                password: "أخيتوفل", // تحديث كلمة السر
                reveal_content: "المرارة تنفع لمسح العيون التي عليها غشاء وبها سوائل لا تصلح لنمو البكتيريا",
                next_button_text: "أنهي المغامرة!"
            },
        ]
    };

    // حالة اللعبة
    let gameState = {
        view: 'splash', // splash, team_select, clue, password_entry, content_reveal, game_end
        teamId: null,
        currentStage: 0, // يبدأ من 0 (قبل المرحلة الأولى)
    };

    const app = document.getElementById('app');
    const teams = ["فريق نينوى", "فريق راجيس", "فريق ارارط", "فريق أورشليم"];

    // ------------------- وظائف عرض الرسائل -------------------

    function showMessageBox(title, content, isError = true) {
        const titleEl = document.getElementById('message-title');
        const contentEl = document.getElementById('message-content');
        const boxEl = document.getElementById('message-box');

        titleEl.textContent = title;
        contentEl.textContent = content;
        titleEl.className = isError ? 'text-2xl font-black mb-3 text-primary' : 'text-2xl font-black mb-3 text-secondary';

        boxEl.classList.remove('hidden');
        boxEl.classList.add('flex');
    }

    function hideMessageBox() {
        document.getElementById('message-box').classList.add('hidden');
        document.getElementById('message-box').classList.remove('flex');
    }

    // ------------------- وظيفة التبديل بين المشاهد -------------------

    function render() {
        // العثور على زر التبديل الخارجي لمفتاح الشفرة
        const cipherButtonToggle = document.getElementById('cipher-button-toggle');

        let content = '';
        
        // التحقق من وجود بيانات للفريق والمرحلة الحالية
        const teamData = TEAM_STAGES[gameState.teamId];
        const currentData = teamData ? teamData[gameState.currentStage] : null;

        if (gameState.view !== 'game_end' && gameState.view !== 'splash' && gameState.view !== 'team_select' && !currentData) {
             // في حالة عدم وجود بيانات للمرحلة الحالية (مثلاً تم الانتهاء من جميع المراحل)
             gameState.view = 'game_end';
        }


        // التحكم في إظهار وإخفاء الزر الخارجي بناءً على حالة اللعبة
        if (cipherButtonToggle) {
            if (gameState.view === 'splash' || gameState.view === 'team_select') {
                cipherButtonToggle.classList.add('hidden');
            } else {
                // الزر يظهر بمجرد بدء اللعبة
                cipherButtonToggle.classList.remove('hidden');
            }
        }
        
        // ** ملاحظة: تم إزالة المنطق الذي يتحكم في إخفاء/إظهار اللوجو هنا، 
        // ليبقى ظاهراً في الخلفية دائماً كجزء من التصميم.**

        switch (gameState.view) {
            case 'splash':
                content = renderSplash();
                break;
            case 'team_select':
                content = renderTeamSelect();
                break;
            case 'clue':
                content = renderClue(currentData);
                break;
            case 'password_entry':
                content = renderPasswordEntry(currentData);
                break;
            case 'content_reveal':
                content = renderContentReveal(currentData);
                break;
            case 'game_end':
                content = renderGameEnd();
                break;
        }

        // إدراج محتوى المشهد داخل الحاوية الرئيسية
        app.innerHTML = `<div class="p-8 md:p-10">${content}</div>`;
    }

    // ------------------- وظائف عرض المشاهد -------------------

    function renderSplash() {
        return `
            <!-- تم إزالة border-b-6 border-primary من هنا ليصبح اللوجو جزءاً من الخلفية -->
            <div class="text-center py-10 bg-primary/10 rounded-t-xl">
                <!-- اللوجو لم يعد هنا، ولكنه يظهر الآن كخلفية ثابتة في البداية عبر دالة render -->
                
                <h1 class="text-5xl md:text-6xl font-black text-primary mb-6 splash-title transition duration-300 mt-20 md:mt-10">
                    البحث عن الكنز
                </h1>
            </div>
            <div class="p-8 text-center bg-white rounded-b-xl">
                <p class="text-xl text-gray-700 font-bold mb-8 mt-4">انقر للبدء!</p>
                <button onclick="startGame()" class="w-full bg-secondary btn-comic-secondary text-white py-3 rounded-xl text-2xl font-black hover:bg-secondary/90 transition duration-300 transform shadow-xl">
                    ابدأ اللعب!
                </button>
            </div>
        `;
    }

    function renderTeamSelect() {
        const teamButtons = teams.map((teamName, index) => `
            <button onclick="selectTeam(${index + 1})"
                class="w-full text-right bg-white border-4 border-gray-400 text-gray-800 py-4 px-6 rounded-xl mb-3 shadow hover:shadow-lg hover:border-primary transition duration-200 transform hover:translate-x-1 font-bold text-xl"
            >
                <span class="font-black text-primary ml-4">#${index + 1}</span> ${teamName}
            </button>
        `).join('');

        return `
            <h2 class="text-3xl font-black text-gray-800 mb-8 border-b-4 pb-3 border-accent">اختر فريقك</h2>
            <p class="text-lg text-gray-700 mb-6 font-bold">انطلق في المغامرة باختيار اسم فريقك:</p>
            <div class="space-y-4">
                ${teamButtons}
            </div>
        `;
    }

    function renderClue(data) {
        return `
            <div class="text-center mb-6">
                <p class="text-lg text-gray-600 mb-1 font-bold">الفريق الحالي: <span class="font-black text-primary">${teams[gameState.teamId - 1]}</span></p>
                <h3 class="text-4xl font-black text-gray-800 mb-8 border-b-4 pb-2 border-primary">المرحلة ${data.stage} - وجهة البحث</h3>
            </div>

            <!-- إظهار الموقع بوضوح -->
            <p class="text-center text-2xl font-black text-secondary mb-4 p-2 border-4 border-dashed border-secondary rounded-lg">
                وجهتكم: ${data.location_name}
            </p>
            
            <div class="clue-box p-6 rounded-xl mb-8 shadow-md">
                <!-- عرض التعليمات المباشرة -->
                <p class="text-2xl font-bold text-gray-900 leading-loose">${data.clue}</p> 
            </div>
            
            <p class="text-center text-lg text-gray-800 mb-8 font-bold">
                عند الوصول للمكان وتحديد كلمة السر... اضغط على زر "وصلنا المكان"
            </p>
            
            <button onclick="showPasswordEntry()" class="w-full bg-secondary btn-comic-secondary text-white py-3 rounded-xl text-2xl font-black transition duration-300 transform shadow-xl">
                وصلنا المكان
            </button>
        `;
    }

    function renderPasswordEntry(data) {
        return `
            <h3 class="text-4xl font-black text-gray-800 mb-6 border-b-4 pb-2 border-primary">كلمة السر</h3>
            <p class="text-lg text-gray-700 mb-8 font-bold">
                لقد وصلت إلى <span class="font-black text-primary">${data.location_name}</span>. أدخل كلمة السر الموجودة في الورقة:
            </p>
            
            <input type="text" id="password-input" class="w-full p-4 border-4 border-primary bg-yellow-50 rounded-lg text-center text-3xl font-black tracking-widest uppercase mb-8 focus:border-secondary focus:ring-secondary transition" placeholder="كلمة السر..." />
            
            <button onclick="checkPassword()" class="w-full bg-primary btn-comic-primary text-white py-3 rounded-xl text-2xl font-black transition duration-300 transform shadow-xl">
                تحقق من كلمة السر
            </button>
        `;
    }

    function renderContentReveal(data) {
        // التحقق من عدد المراحل للفريق الحالي
        const currentTeamStages = TEAM_STAGES[gameState.teamId];
        const isFinal = gameState.currentStage === currentTeamStages.length - 1;
        const nextAction = isFinal ? 'endGame()' : 'nextStage()';
        const buttonText = data.next_button_text;
        
        let revealBlock = '';
        
        // إذا كان نص الإنجاز هو شبهة (المرحلة 1)
        const isDoubtStage = (data.stage === 1 && data.reveal_content.includes("الملاك كذب") || data.reveal_content.includes("الصدقة تغفر") || data.reveal_content.includes("استخدم الكبد") || data.reveal_content.includes("يفقد نظره"));


        if (data.reveal_content && data.reveal_content.trim() !== '') {
             revealBlock = `
                <h3 class="text-4xl font-black mb-6 border-b-4 pb-2 ${isDoubtStage ? 'text-primary border-primary' : 'text-secondary border-secondary'}">
                    ${isDoubtStage ? 'لحظة تفكير!' : 'عمل رائع! الإنجاز'}
                </h3>
                
                ${isDoubtStage ? `
                    <p class="text-2xl font-black text-primary mb-4 p-2 border-4 border-dashed border-primary rounded-lg text-center">
                        فكر في هذه الشبهة جيدًا...
                    </p>
                ` : `<p class="text-lg text-gray-700 mb-4 font-bold text-center">
                    هذا هو النص أو الشاهد المطلوب:
                </p>`}
                
                <div class="${isDoubtStage ? 'doubt-box border-l-8 border-primary' : 'bg-accent border-l-8 border-secondary'} p-6 rounded-xl mb-8 shadow-inner clue-box text-center">
                    <!-- استخدام pre-wrap للحفاظ على تنسيق الأسطر الجديدة في حالة الشواهد المتعددة أو النص الطويل -->
                    <p class="text-xl md:text-2xl text-gray-900 leading-relaxed font-black" style="white-space: pre-wrap;">${data.reveal_content}</p>
                </div>
            `;
        } else {
             // هذا الجزء لا ينبغي أن يظهر بعد التحديثات، لكن نتركه كاحتياط
             revealBlock = `
                 <h3 class="text-4xl font-black text-secondary mb-6 border-b-4 pb-2 border-secondary">عمل رائع! أكملت المرحلة بنجاح!</h3>
                 <p class="text-xl text-gray-700 mb-4 font-bold text-center">
                    أحسنت! لا يوجد نص إضافي لهذه المرحلة، انتقل مباشرة للتحدي التالي.
                 </p>
             `;
        }


        return `
            ${revealBlock}
            
            <p class="text-center text-lg text-gray-700 mb-8 font-bold">
                أكملت المرحلة ${data.stage}. استعد للمرحلة التالية.
            </p>
            
            <button onclick="${nextAction}" class="w-full bg-primary btn-comic-primary text-white py-3 rounded-xl text-2xl font-black transition duration-300 transform shadow-xl">
                ${buttonText}
            </button>
        `;
    }

    function renderGameEnd() {
        return `
            <div class="text-center py-20 bg-secondary/10 rounded-t-xl border-b-4 border-secondary">
                <h1 class="text-5xl font-black text-secondary mb-4 splash-title">
                    انتهت المغامرة!
                </h1>
                <p class="text-xl text-gray-700 font-bold">لقد أتممت جميع مراحل البحث عن الكنز بنجاح.</p>
            </div>
            <div class="p-8 text-center">
                <p class="text-3xl font-black text-primary mb-8">
                    فريق <span class="text-secondary">${teams[gameState.teamId - 1]}</span>، أنتم الأبطال!
                </p>
                <button onclick="resetGame()" class="w-full bg-primary btn-comic-primary text-white py-3 rounded-xl text-2xl font-black transition duration-300 shadow-xl">
                    العودة للبداية
                </button>
            </div>
        `;
    }

    // ------------------- وظائف منطق اللعبة -------------------

    function toggleCipherKey() {
        const modal = document.getElementById('cipher-key-modal');
        if (modal.classList.contains('translate-x-full')) {
            // فتح الشريط الجانبي
            modal.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden'; // منع السكرول عندما يكون الشريط مفتوحاً
        } else {
            // إغلاق الشريط الجانبي
            modal.classList.add('translate-x-full');
            document.body.style.overflow = 'auto';
        }
    }
    
    function startGame() {
        gameState.view = 'team_select';
        render();
    }

    function selectTeam(id) {
        // التحقق من وجود بيانات لهذا الفريق
        if (TEAM_STAGES[id]) {
            gameState.teamId = id;
            gameState.currentStage = 0; // البدء بالمرحلة الأولى
            gameState.view = 'clue';
            render();
        } else {
             showMessageBox(
                "خطأ في بيانات الفريق",
                "لا توجد بيانات مراحل محددة لهذا الفريق بعد. يرجى اختيار فريق آخر.",
                true
            );
        }
    }

    function showPasswordEntry() {
        gameState.view = 'password_entry';
        render();
    }

    function checkPassword() {
        const input = document.getElementById('password-input').value.trim();
        const currentData = TEAM_STAGES[gameState.teamId][gameState.currentStage];

        // إزالة المسافات المتعددة وتحويل للحروف الصغيرة للمقارنة
        const cleanInput = input.replace(/\s+/g, ' ').toLowerCase(); 
        const cleanExpected = currentData.password.replace(/\s+/g, ' ').toLowerCase();

        if (cleanInput === cleanExpected) {
            gameState.view = 'content_reveal';
            render();
        } else {
            showMessageBox(
                "كلمة السر خاطئة!",
                "يرجى التأكد من إدخال كلمة السر الموجودة في الورقة بشكل صحيح.",
                true
            );
        }
    }

    function nextStage() {
        gameState.currentStage++;
        const currentTeamStages = TEAM_STAGES[gameState.teamId];

        if (gameState.currentStage < currentTeamStages.length) {
            gameState.view = 'clue';
        } else {
            gameState.view = 'game_end';
        }
        render();
    }

    function endGame() {
        gameState.view = 'game_end';
        render();
    }

    function resetGame() {
        gameState = {
            view: 'splash',
            teamId: null,
            currentStage: 0,
        };
        // إغلاق مفتاح الشفرة إذا كان مفتوحاً
        const modal = document.getElementById('cipher-key-modal');
        if (!modal.classList.contains('translate-x-full')) {
            modal.classList.add('translate-x-full');
            document.body.style.overflow = 'auto';
        }
        render();
    }

    // تهيئة اللعبة عند التحميل
    window.onload = render;

</script>
</body>
</html>
